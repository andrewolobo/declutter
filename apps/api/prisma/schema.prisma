// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id                Int       @id @default(autoincrement()) @map("UserID")
  email             String    @unique @db.VarChar(255) @map("Email")
  phoneNumber       String    @db.VarChar(20) @map("PhoneNumber")
  paymentsNumber    String?   @db.VarChar(20) @map("PaymentsNumber")
  fullName          String    @db.VarChar(255) @map("FullName")
  passwordHash      String?   @db.VarChar(255) @map("PasswordHash")
  oauthProvider     String?   @db.VarChar(50) @map("OAuthProvider")
  oauthProviderId   String?   @db.VarChar(255) @map("OAuthProviderId")
  profilePictureUrl String?   @db.VarChar(500) @map("ProfilePictureURL")
  location          String?   @db.VarChar(255) @map("Location")
  bio               String?   @db.VarChar(500) @map("Bio")
  isEmailVerified   Boolean   @default(false) @map("IsEmailVerified")
  isPhoneVerified   Boolean   @default(false) @map("IsPhoneVerified")
  isActive          Boolean   @default(true) @map("IsActive")
  isAdmin           Boolean   @default(false) @map("IsAdmin")
  createdAt         DateTime  @default(now()) @map("CreatedAt") @db.Timestamp
  updatedAt         DateTime  @updatedAt @map("UpdatedAt") @db.Timestamp

  // Relations (implicit - no FK constraints in DB)
  posts             Post[]
  likes             Like[]
  payments          Payment[]
  sentMessages      Message[] @relation("SentMessages")
  receivedMessages  Message[] @relation("ReceivedMessages")
  views             View[]

  @@index([email], map: "IX_Users_Email")
  @@index([phoneNumber], map: "IX_Users_PhoneNumber")
  @@map("Users")
}

// ============================================
// Content Management
// ============================================

model Category {
  id          Int      @id @default(autoincrement()) @map("CategoryID")
  name        String   @db.VarChar(100) @map("CategoryName")
  description String?  @db.VarChar(500) @map("Description")
  iconUrl     String?  @db.VarChar(500) @map("IconURL")
  createdAt   DateTime @default(now()) @map("CreatedAt") @db.Timestamp

  // Relations (implicit - no FK constraints in DB)
  posts       Post[]

  @@map("Categories")
}

model Post {
  id                   Int       @id @default(autoincrement()) @map("PostID")
  userId               Int       @map("UserID")
  title                String    @db.VarChar(255) @map("Title")
  categoryId           Int       @map("CategoryID")
  brand                String?   @db.VarChar(100) @map("Brand")
  description          String    @db.Text @map("Description")
  price                Decimal   @db.Decimal(18, 2) @map("Price")
  location             String    @db.VarChar(255) @map("Location")
  gpsLocation          String?   @map("GPSLocation") // geography type stored as string
  deliveryMethod       String?   @db.VarChar(100) @map("DeliveryMethod")
  contactNumber        String    @db.VarChar(20) @map("ContactNumber")
  emailAddress         String?   @db.VarChar(255) @map("EmailAddress")
  status               String    @db.VarChar(50) @map("Status")
  scheduledPublishTime DateTime? @map("ScheduledPublishTime") @db.Timestamp
  publishedAt          DateTime? @map("PublishedAt") @db.Timestamp
  expiresAt            DateTime? @map("ExpiresAt") @db.Timestamp
  viewCount            Int       @default(0) @map("ViewCount")
  likeCount            Int       @default(0) @map("LikeCount")
  pricingTierId        Int?      @map("Tier")
  instagramPostId      String?   @db.VarChar(255) @map("InstagramPostID")
  instagramPostedAt    DateTime? @map("InstagramPostedAt") @db.Timestamp
  createdAt            DateTime  @default(now()) @map("CreatedAt") @db.Timestamp
  updatedAt            DateTime  @updatedAt @map("UpdatedAt") @db.Timestamp

  // Relations (implicit - no FK constraints in DB)
  user                 User         @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  category             Category     @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  pricingTier          PricingTier? @relation(fields: [pricingTierId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  images               PostImage[]
  likes                Like[]
  payments             Payment[]
  messages             Message[]
  views                View[]
  analytics            ViewAnalytics[]

  @@index([status, publishedAt(sort: Desc)], map: "IX_Posts_Status_PublishedAt")
  @@index([categoryId], map: "IX_Posts_CategoryID")
  @@index([userId], map: "IX_Posts_UserID")
  @@map("Posts")
}

model PostImage {
  id           Int      @id @default(autoincrement()) @map("ImageID")
  postId       Int      @map("PostID")
  imageUrl     String   @db.VarChar(500) @map("ImageURL")
  displayOrder Int      @default(0) @map("DisplayOrder")
  createdAt    DateTime @default(now()) @map("CreatedAt") @db.Timestamp

  // Relations (implicit - no FK constraints in DB)
  post         Post     @relation(fields: [postId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("PostImages")
}

model Like {
  id        Int      @id @default(autoincrement()) @map("LikeID")
  postId    Int      @map("PostID")
  userId    Int      @map("UserID")
  createdAt DateTime @default(now()) @map("CreatedAt") @db.Timestamp

  // Relations (implicit - no FK constraints in DB)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user      User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([postId, userId], map: "UQ_Likes_PostID_UserID")
  @@index([postId], map: "IX_Likes_PostID")
  @@index([userId], map: "IX_Likes_UserID")
  @@map("Likes")
}

// ============================================
// Messaging
// ============================================

model Message {
  id             Int       @id @default(autoincrement()) @map("MessageID")
  senderId       Int       @map("SenderID")
  recipientId    Int       @map("RecipientID")
  postId         Int?      @map("PostID")
  content        String    @db.Text @map("MessageContent")
  messageType    String    @default("text") @db.VarChar(20) @map("MessageType")
  attachmentUrl  String?   @db.VarChar(500) @map("AttachmentURL")
  // Recipient read status (has the recipient read this message?)
  isReadByRecipient Boolean   @default(false) @map("IsReadByRecipient")
  recipientReadAt   DateTime? @map("RecipientReadAt") @db.Timestamp
  // Sender read status (has the sender seen/acknowledged the conversation since sending?)
  isReadBySender    Boolean   @default(true) @map("IsReadBySender")
  senderReadAt      DateTime? @map("SenderReadAt") @db.Timestamp
  // Legacy field kept for backward compatibility (maps to isReadByRecipient behavior)
  isRead         Boolean   @default(false) @map("IsRead")
  readAt         DateTime? @map("ReadAt") @db.Timestamp
  isDeleted      Boolean   @default(false) @map("IsDeleted")
  deletedBy      Int?      @map("DeletedBy")
  isEdited       Boolean   @default(false) @map("IsEdited")
  editedAt       DateTime? @map("EditedAt") @db.Timestamp
  parentMessageId Int?     @map("ParentMessageID")
  createdAt      DateTime  @default(now()) @map("CreatedAt") @db.Timestamp
  updatedAt      DateTime  @updatedAt @map("UpdatedAt") @db.Timestamp

  // Relations (implicit - no FK constraints in DB)
  sender         User      @relation("SentMessages", fields: [senderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  recipient      User      @relation("ReceivedMessages", fields: [recipientId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  post           Post?     @relation(fields: [postId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  parentMessage  Message?  @relation("MessageReplies", fields: [parentMessageId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies        Message[] @relation("MessageReplies")

  @@index([senderId], map: "IX_Messages_SenderID")
  @@index([recipientId], map: "IX_Messages_RecipientID")
  @@index([senderId, recipientId], map: "IX_Messages_Conversation")
  @@index([postId], map: "IX_Messages_PostID")
  @@index([createdAt(sort: Desc)], map: "IX_Messages_CreatedAt")
  @@map("Messages")
}

// ============================================
// Payments & Pricing
// ============================================

model Payment {
  id                   Int       @id @default(autoincrement()) @map("PaymentID")
  postId               Int       @map("PostID")
  userId               Int       @map("UserID")
  amount               Decimal   @db.Decimal(18, 2) @map("Amount")
  currency             String    @default("UGX") @db.VarChar(3) @map("Currency")
  paymentMethod        String    @db.VarChar(50) @map("PaymentMethod")
  transactionReference String?   @db.VarChar(255) @map("TransactionReference")
  status               String    @db.VarChar(50) @map("Status")
  confirmedAt          DateTime? @map("ConfirmedAt") @db.Timestamp
  createdAt            DateTime  @default(now()) @map("CreatedAt") @db.Timestamp

  // Relations (implicit - no FK constraints in DB)
  post                 Post      @relation(fields: [postId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user                 User      @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("Payments")
}

model PricingTier {
  id             Int      @id @default(autoincrement()) @map("TierID")
  name           String   @unique @db.VarChar(100) @map("TierName")
  visibilityDays Int      @map("VisibilityDays")
  price          Decimal  @db.Decimal(18, 2) @map("Price")
  description    String?  @db.VarChar(500) @map("Description")
  isActive       Boolean  @default(true) @map("IsActive")
  createdAt      DateTime @default(now()) @map("CreatedAt") @db.Timestamp

  // Relations (implicit - no FK constraints in DB)
  posts          Post[]

  @@map("PricingTiers")
}

// ============================================
// Analytics & Views
// ============================================

model View {
  id           Int      @id @default(autoincrement()) @map("ViewID")
  postId       Int      @map("PostID")
  userId       Int?     @map("UserID")
  ipAddress    String?  @db.VarChar(45) @map("IPAddress")
  userAgent    String?  @db.VarChar(500) @map("UserAgent")
  referrerUrl  String?  @db.VarChar(500) @map("ReferrerURL")
  sessionId    String?  @db.VarChar(100) @map("SessionID")
  viewDuration Int?     @map("ViewDuration")
  isUnique     Boolean  @default(true) @map("IsUnique")
  createdAt    DateTime @default(now()) @map("CreatedAt") @db.Timestamp

  // Relations (implicit - no FK constraints in DB)
  post         Post     @relation(fields: [postId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user         User?    @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([postId], map: "IX_Views_PostID")
  @@index([userId], map: "IX_Views_UserID")
  @@index([createdAt], map: "IX_Views_CreatedAt")
  @@index([sessionId], map: "IX_Views_SessionID")
  @@index([postId, userId], map: "IX_Views_PostID_UserID")
  @@index([postId, ipAddress], map: "IX_Views_PostID_IPAddress")
  @@map("Views")
}

model ViewAnalytics {
  id                   Int      @id @default(autoincrement()) @map("AnalyticsID")
  postId               Int      @map("PostID")
  date                 DateTime @db.Date @map("Date")
  totalViews           Int      @default(0) @map("TotalViews")
  uniqueViews          Int      @default(0) @map("UniqueViews")
  authenticatedViews   Int      @default(0) @map("AuthenticatedViews")
  anonymousViews       Int      @default(0) @map("AnonymousViews")
  averageViewDuration  Int?     @map("AverageViewDuration")
  createdAt            DateTime @default(now()) @map("CreatedAt") @db.Timestamp
  updatedAt            DateTime @updatedAt @map("UpdatedAt") @db.Timestamp

  // Relations (implicit - no FK constraints in DB)
  post                 Post     @relation(fields: [postId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([postId, date], map: "UQ_ViewAnalytics_PostID_Date")
  @@index([postId], map: "IX_ViewAnalytics_PostID")
  @@index([date(sort: Desc)], map: "IX_ViewAnalytics_Date")
  @@map("ViewAnalytics")
}
